# CSRF Token and Potluck Contributors Fix

## Issues Fixed

### 1. CSRF Token Missing on Delete Forms ✅

**Problem**: When attempting to delete/remove a potluck item, the error "The CSRF token is missing" was displayed.

**Root Cause**: The delete forms in `app/templates/public/event_detail.html` and `app/templates/guests/household_detail.html` were missing the CSRF token hidden input field.

**Solution**: Added CSRF token hidden input fields to all POST forms:

```html
<input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
```

**Files Modified**:
- `app/templates/public/event_detail.html` (lines 253, 320) - Added CSRF tokens to potluck item delete forms
- `app/templates/guests/household_detail.html` (lines 28, 107) - Added CSRF tokens to household/person delete forms

### 2. Potluck Contributors JavaScript Issues ✅

**Problem**: Contributors functionality had potential issues with:
- DOM elements not being available when JavaScript runs
- Missing null checks causing potential errors
- Form validation errors not being caught properly

**Root Cause**: 
1. JavaScript code was running before DOM was fully loaded
2. Missing null/undefined checks for DOM elements
3. JSON parsing errors not properly handled

**Solution**: 
1. Wrapped initialization code in `DOMContentLoaded` event listener
2. Added null checks for all DOM element references
3. Improved error handling for JSON parsing
4. Added comprehensive console logging for debugging

**Files Modified**:
- `app/templates/public/potluck_form.html` - Complete refactor of JavaScript code

**Key Changes**:
- Moved DOM element initialization inside `DOMContentLoaded`
- Made functions global scope for inline `onclick` handlers
- Added null checks: `if (contributorHiddenInput)`, `if (tagInput)`, etc.
- Improved JSON parsing with try-catch blocks
- Added detailed console logging for debugging

## How It Works Now

### CSRF Protection
All POST forms now include the CSRF token, which Flask-WTF validates on submission:
1. Token is generated by `{{ csrf_token() }}` function
2. Token is included as hidden input field
3. Flask-WTF validates token on POST request
4. If token is missing or invalid, request is rejected

### Contributors Selection
1. **Page Load**: 
   - DOM loads completely
   - JavaScript initializes DOM element references
   - Reads `contributor_ids` from hidden field (JSON array)
   - Checks corresponding checkboxes

2. **User Interaction**:
   - User checks/unchecks contributor checkboxes
   - `updateContributors()` function is called (via `onchange` handler)
   - Function reads all checked checkboxes
   - Updates hidden field with JSON array of IDs

3. **Form Submission**:
   - Form submit event fires
   - `updateContributors()` called one final time
   - Validates at least one contributor is selected
   - If valid, form submits with JSON array in hidden field
   - Backend parses JSON and saves contributors

## Additional Fix: ReferenceError for updateContributors ✅

**Problem**: JavaScript console error: "ReferenceError: Can't find variable: updateContributors"

**Root Cause**: The `updateContributors()` function was defined inside the `DOMContentLoaded` event listener, making it inaccessible to the inline `onchange="updateContributors()"` handler in the HTML.

**Solution**: Moved all functions that are called from inline handlers to the global scope (outside the DOMContentLoaded):
- `addTag()`
- `removeTag()`
- `renderTags()`
- `updateHiddenInput()`
- `updateContributors()`

These functions now exist at the global scope but still reference the global variables that are initialized inside DOMContentLoaded.

## Critical Fix: Contributors Not Being Saved ✅

**Problem**: When editing a potluck item and changing contributors, the changes were not being saved to the database.

**Root Cause**: In the `edit_potluck_item` route, the form fields were being pre-populated with the existing item data on EVERY request (both GET and POST). This meant that when the form was submitted (POST), the submitted data was immediately overwritten with the old data before validation, so the changes were never processed.

**Buggy Code** (lines 556-569):
```python
# Pre-populate form fields manually
form.name.data = item.name
form.category.data = item.category
form.notes.data = item.notes
form.dietary_tags.data = json.dumps(item.dietary_tags if item.dietary_tags else [])
form.contributor_ids.data = json.dumps(item.contributor_ids)
```

This code ran on BOTH GET and POST requests, overwriting the submitted form data!

**Solution**: Wrapped the form pre-population in a `if request.method == 'GET':` check so it only runs when initially loading the form, not when processing the submission.

**Fixed Code**:
```python
# Pre-populate form fields manually on GET
if request.method == 'GET':
    form.name.data = item.name
    form.category.data = item.category
    form.notes.data = item.notes
    form.dietary_tags.data = json.dumps(item.dietary_tags if item.dietary_tags else [])
    form.contributor_ids.data = json.dumps(item.contributor_ids)
```

**Additional Fix**: Changed line 520 to always pass `contributor_ids` to the service (even if it's an empty list), instead of passing `None` when the list is empty. This allows clearing contributors if needed (though the frontend validation currently prevents this).

**Why This Was So Insidious**:
1. The form appeared to work correctly - JavaScript updated the hidden field
2. The form submitted successfully - no errors were shown
3. The page redirected back to the event detail page
4. But the changes weren't saved because the submitted data was overwritten before processing!

**Flow Comparison**:

**BEFORE (Buggy)**:
```
1. User edits form and changes contributors from [1] to [1, 2]
2. JavaScript updates hidden field to "[1,2]"
3. User submits form (POST request)
4. Flask receives POST data: contributor_ids="[1,2]"
5. Form object created: form.contributor_ids.data = "[1,2]"
6. ❌ BUG: Code runs form.contributor_ids.data = json.dumps([1])  (overwrites!)
7. Form validation runs with OLD data: contributor_ids="[1]"
8. Database updated with [1] (no change!)
```

**AFTER (Fixed)**:
```
1. User edits form and changes contributors from [1] to [1, 2]
2. JavaScript updates hidden field to "[1,2]"
3. User submits form (POST request)
4. Flask receives POST data: contributor_ids="[1,2]"
5. Form object created: form.contributor_ids.data = "[1,2]"
6. ✅ Pre-population skipped (only runs on GET)
7. Form validation runs with NEW data: contributor_ids="[1,2]"
8. Database updated with [1, 2] (change saved!)
```

## Testing Checklist

- [x] Delete potluck item (logged in user) - CSRF token fix
- [x] Delete potluck item (guest with token) - CSRF token fix
- [x] updateContributors() function accessible from inline handlers - JavaScript scope fix
- [x] Form pre-population only on GET requests - Critical bug fix
- [ ] Add potluck item with single contributor
- [ ] Add potluck item with multiple contributors
- [ ] Edit potluck item and change contributors (should now work!)
- [ ] Edit potluck item name/category/notes (verify other fields still work)
- [ ] Try to submit form with no contributors (should show error)
- [ ] Delete household (organizer) - CSRF token fix
- [ ] Remove person from household (organizer) - CSRF token fix

## Debug Console Output

When working with contributors, you should see console output like:
```
Initializing contributors: [1, 2]
Checked checkbox for person ID 1
Checked checkbox for person ID 2
updateContributors called
Found checkboxes: 2
Contributor IDs: [1, 2]
Updated hidden field to: [1,2]
```

## Backend Processing

The backend routes handle contributor IDs as follows:

1. **Receive**: `form.contributor_ids.data` (JSON string like `"[1,2,3]"`)
2. **Parse**: `json.loads(form.contributor_ids.data)` → Python list `[1, 2, 3]`
3. **Save**: `PotluckService.create_item(contributor_ids=[1, 2, 3])`
4. **Database**: Creates `PotluckItemContributor` records for each ID

## JavaScript Structure (Final)

```javascript
<script>
// 1. GLOBAL SCOPE - Variables and constants
let selectedTags = [];
let tagInput, tagSuggestions, selectedTagsContainer, hiddenInput;
let contributorHiddenInput, contributorError;
const commonTags = [...];

// 2. DOM READY - Initialize and setup event listeners
document.addEventListener('DOMContentLoaded', function() {
    // Initialize DOM element references
    tagInput = document.getElementById('tag-input');
    contributorHiddenInput = document.getElementById('contributor_ids_hidden');
    // ... etc

    // Setup event listeners
    tagInput.addEventListener('input', function() { ... });

    // Initialize form state
    if (contributorHiddenInput && contributorHiddenInput.value) {
        // Check checkboxes based on existing data
    }
}); // End of DOMContentLoaded

// 3. GLOBAL FUNCTIONS - Accessible from inline handlers
function addTag(tag) { ... }
function removeTag(tag) { ... }
function renderTags() { ... }
function updateHiddenInput() { ... }
function updateContributors() { ... }
</script>
```

## Related Files

- `app/routes/public.py` - Potluck add/edit/delete routes
- `app/services/potluck_service.py` - Business logic
- `app/models/potluck.py` - PotluckItem and PotluckItemContributor models
- `app/forms/potluck_forms.py` - PotluckItemForm definition
- `app/__init__.py` - CSRF protection initialization
- `app/templates/public/potluck_form.html` - Form template with JavaScript
- `app/templates/public/event_detail.html` - Event detail with delete forms
- `app/templates/guests/household_detail.html` - Household detail with delete forms

